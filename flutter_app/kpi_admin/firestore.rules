rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    // Read the caller's user doc safely
    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return signedIn() && me().data.role == 'admin';
    }

    function isApproved(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.approved == true;
    }

    // driver user created by Cloud Function
    function isDriver() {
      return signedIn() && me().data.role == 'driver';
    }

    // is the caller a driver that belongs to this DSP userId?
    // (requires users/{driverUid} to have a field "dspUid")
    function isDriverOf(userId) {
      return isDriver() && me().data.dspUid == userId;
    }

    match /users/{userId} {
      // Created by the user at signup (DSP/admin + also driver profiles)
      allow create: if isSelf(userId);

      // Everyone can read their OWN user doc; admin can read all
      allow read: if isSelf(userId) || isAdmin();

      // Only admins may update/delete user docs (for now)
      allow update: if isAdmin();
      allow delete: if isAdmin();

      // ---------- reports (scorecards) ----------
      // users/{userId}/reports/{reportId}
      match /reports/{reportId} {
        // DSP itself can read + write its own reports (and must be approved)
        allow read: if isSelf(userId) && isApproved(userId);
        allow write: if isSelf(userId) && isApproved(userId);

        // Drivers of this DSP can READ reports (for dashboard)
        allow read: if isDriverOf(userId) && isApproved(userId);

        // per-report driver name mappings
        match /driverNames/{nameId} {
          // DSP full access
          allow read: if isSelf(userId) && isApproved(userId);
          allow write: if isSelf(userId) && isApproved(userId);

          // drivers of this DSP can read for display
          allow read: if isDriverOf(userId) && isApproved(userId);
        }
      }

      // ---------- scores for a report ----------
      // users/{userId}/scores/{scoreId}
      match /scores/{scoreId} {
        // DSP full access
        allow read: if isSelf(userId) && isApproved(userId);
        allow write: if isSelf(userId) && isApproved(userId);

        // drivers of this DSP can read all scores (for ranking view)
        allow read: if isDriverOf(userId) && isApproved(userId);
      }

      // ---------- driver master data ----------
      // users/{userId}/drivers/{driverId}   (driverId == TransporterID)
      match /drivers/{driverId} {

        // DSP can fully manage its driver list
        allow read: if isSelf(userId) && isApproved(userId);
        allow create, delete: if isSelf(userId) && isApproved(userId);
        allow update: if isSelf(userId) && isApproved(userId);

        // Driver can read + update ONLY his own driver doc
        // requires users/{driverUid} to have:
        //   dspUid: <dspUid>
        //   transporterId: <TransporterID string>
        allow read, update: if isDriverOf(userId)
          && me().data.transporterId == driverId;
      }
    }
  }
}
